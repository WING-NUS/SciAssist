<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SciAssist.pipelines.summarization &mdash; SciAssist 0.0.4 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> SciAssist
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Models.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Contribution.html">Contribute</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">SciAssist</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>SciAssist.pipelines.summarization</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for SciAssist.pipelines.summarization</h1><div class="highlight"><pre>
<span></span><span class="c1"># main developer: Yixi Ding &lt;dingyixi@hotmail.com&gt;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">Dataset</span>

<span class="kn">from</span> <span class="nn">SciAssist</span> <span class="kn">import</span> <span class="n">BASE_CACHE_DIR</span><span class="p">,</span> <span class="n">BASE_TEMP_DIR</span><span class="p">,</span> <span class="n">BASE_OUTPUT_DIR</span>
<span class="kn">from</span> <span class="nn">SciAssist.pipelines.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">SciAssist.utils.pdf2text</span> <span class="kn">import</span> <span class="n">process_pdf_file</span><span class="p">,</span> <span class="n">get_bodytext</span>


<div class="viewcode-block" id="SingleSummarization"><a class="viewcode-back" href="../../../Usage.html#SciAssist.SingleSummarization">[docs]</a><span class="k">class</span> <span class="nc">SingleSummarization</span><span class="p">(</span><span class="n">Pipeline</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The pipeline for reference string parsing.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_name (`str`, *optional*):</span>
<span class="sd">            A string, the *model name* of a pretrained model provided for this task.</span>
<span class="sd">        device (`str`, *optional*):</span>
<span class="sd">            A string, `cpu` or `gpu`.</span>
<span class="sd">        cache_dir (`str` or `os.PathLike`, *optional*):</span>
<span class="sd">            Path to a directory in which a downloaded pretrained model should be</span>
<span class="sd">            cached if the standard cache should not be used.</span>
<span class="sd">        output_dir (`str` or `os.PathLike`, *optional*):</span>
<span class="sd">            Path to a directory in which the predicted results files should be stored.</span>
<span class="sd">        temp_dir (`str` or `os.PathLike`, *optional*):</span>
<span class="sd">            Path to a directory which holds temporary files such as `.tei.xml`.</span>
<span class="sd">        tokenizer (PreTrainedTokenizer, *optional*):</span>
<span class="sd">            A specific tokenizer.</span>
<span class="sd">        checkpoint (`str` or `os.PathLike`, *optional*):</span>
<span class="sd">            A checkpoint for the tokenizer. You can also specify the `checkpoint` while</span>
<span class="sd">            using the default tokenizer.</span>
<span class="sd">            Can be either:</span>

<span class="sd">                - A string, the *model id* of a predefined tokenizer hosted inside a model repo on huggingface.co.</span>
<span class="sd">                  Valid model ids can be located at the root-level, like `bert-base-uncased`, or namespaced under a</span>
<span class="sd">                  user or organization name, like `facebook/bart-large-cnn`.</span>
<span class="sd">                - A path to a *directory* containing vocabulary files required by the tokenizer, for instance saved</span>
<span class="sd">                  using the [`~PreTrainedTokenizer.save_pretrained`] method, e.g., `./my_model_directory/`.</span>
<span class="sd">                - A path or url to a single saved vocabulary file if and only if the tokenizer only requires a</span>
<span class="sd">                  single vocabulary file (like Bert or XLNet), e.g.: `./my_model_directory/vocab.txt`. (Not</span>
<span class="sd">                  applicable to all derived classes)</span>

<span class="sd">        model_max_length (`int`, *optional*): The max sequence length the model accepts.</span>
<span class="sd">        max_source_length (`int`, *optional*): The max length of the input text.</span>
<span class="sd">        max_target_length (`int`, *optional*): The max length of the generated summary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;gpu&quot;</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="n">BASE_CACHE_DIR</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">BASE_OUTPUT_DIR</span><span class="p">,</span>
            <span class="n">temp_dir</span><span class="o">=</span><span class="n">BASE_TEMP_DIR</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">checkpoint</span><span class="o">=</span><span class="s2">&quot;facebook/bart-large-cnn&quot;</span><span class="p">,</span>
            <span class="n">model_max_length</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
            <span class="n">max_source_length</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
            <span class="n">max_target_length</span><span class="o">=</span><span class="mi">128</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">task_name</span><span class="o">=</span><span class="s2">&quot;summarization&quot;</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
                         <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">temp_dir</span><span class="o">=</span><span class="n">temp_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_utils</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_utils</span><span class="p">(</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">model_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">],</span>
            <span class="n">checkpoint</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span>
            <span class="n">model_max_length</span><span class="o">=</span><span class="n">model_max_length</span><span class="p">,</span>
            <span class="n">max_source_length</span><span class="o">=</span><span class="n">max_source_length</span><span class="p">,</span>
            <span class="n">max_target_length</span><span class="o">=</span><span class="n">max_target_length</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_utils</span><span class="o">.</span><span class="n">tokenizer</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pdf&quot;</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">temp_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">num_beams</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">num_return_sequences</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            input (`str` or `List[str]` or `os.PathLike`):</span>
<span class="sd">            Can be either:</span>

<span class="sd">                   - A string, the reference string to be parsed.</span>
<span class="sd">                   - A list of strings to be parsed.</span>
<span class="sd">                   - A path to a *.txt* file to be summarized.</span>
<span class="sd">                   - A path to a *.pdf* file to be summarized, a raw scientific document without processing.</span>
<span class="sd">                     The pipeline will automatically extract the body text from the pdf.</span>

<span class="sd">            type (`str`, default to `pdf`):</span>
<span class="sd">                The type of input, can be either:</span>

<span class="sd">                    - `str` or `string`.</span>
<span class="sd">                    - `text`or `txt` for a .txt file.</span>
<span class="sd">                    - `pdf` for a pdf file. This is the default value.</span>

<span class="sd">            output_dir (`str` or `os.PathLike`, *optional*):</span>
<span class="sd">                Path to a directory in which the predicted results files should be stored.</span>
<span class="sd">            temp_dir (`str` or `os.PathLike`, *optional*):</span>
<span class="sd">                Path to a directory which holds temporary files such as `.tei.xml`.</span>
<span class="sd">            num_beams (`int`, *optional*):</span>
<span class="sd">                Number of beams for beam search. 1 means no beam search.</span>
<span class="sd">                `num_beams` should be divisible by `num_return_sequences` for group beam search.</span>
<span class="sd">            num_return_sequences(`int`):</span>
<span class="sd">                The number of independently computed returned sequences for each element in the batch.</span>
<span class="sd">            save_results (`bool`, default to `True`):</span>
<span class="sd">                Whether to save the tagged labels in a *.txt* file.</span>
<span class="sd">                **Note**: This is invalid when `type` is set to `str` or `string`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `Dict`: { &quot;summary&quot;: [summary1, summary2, ...], &quot;raw_text&quot;: raw_text }</span>


<span class="sd">        Examples:</span>

<span class="sd">             &gt;&gt;&gt; from SciAssist import SingleSummarization</span>
<span class="sd">             &gt;&gt;&gt; pipeline = SingleSummarization()</span>
<span class="sd">             &gt;&gt;&gt; res = pipeline.predict(&#39;N18-3011.pdf&#39;, type=&quot;pdf&quot;, num_beams=3, num_return_sequences=3)</span>
<span class="sd">             &gt;&gt;&gt; res[&quot;summary&quot;]</span>
<span class="sd">             [&#39;The paper proposes a method for extracting structured information from scientific documents into the literature graph. The paper describes the attributes associated with nodes and edges of different types in the graph, and describes how to extract the entities mentioned in paper text. The method is evaluated on three tasks: sequence labeling, entity linking and relation extraction. &#39;,</span>
<span class="sd">             &#39;The paper proposes a method for extracting structured information from scientific documents into the literature graph. The paper describes the attributes associated with nodes and edges of different types in the graph, and describes how to extract the entities mentioned in paper text. The method is evaluated on three tasks: sequence labeling, entity linking and relation extraction.  &#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span>
        <span class="k">if</span> <span class="n">temp_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="s2">&quot;string&quot;</span><span class="p">]:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summarize_for_string</span><span class="p">(</span><span class="n">example</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span> <span class="n">num_beams</span><span class="o">=</span><span class="n">num_beams</span><span class="p">,</span>
                                                 <span class="n">num_return_sequences</span><span class="o">=</span><span class="n">num_return_sequences</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;txt&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">]:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summarize_for_text</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span> <span class="n">num_beams</span><span class="o">=</span><span class="n">num_beams</span><span class="p">,</span>
                                               <span class="n">num_return_sequences</span><span class="o">=</span><span class="n">num_return_sequences</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;pdf&quot;</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summarize_for_pdf</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">temp_dir</span><span class="o">=</span><span class="n">temp_dir</span><span class="p">,</span>
                                              <span class="n">num_beams</span><span class="o">=</span><span class="n">num_beams</span><span class="p">,</span> <span class="n">num_return_sequences</span><span class="o">=</span><span class="n">num_return_sequences</span><span class="p">)</span>
        <span class="c1"># Save predicted results as a text file</span>
        <span class="k">if</span> <span class="n">save_results</span> <span class="ow">and</span> <span class="nb">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="s2">&quot;string&quot;</span><span class="p">]:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">_summ.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">res</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">_to_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="s2">&quot;bart-cnn-on-mup&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;input_ids&quot;</span><span class="p">:</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
                <span class="s2">&quot;attention_mask&quot;</span><span class="p">:</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
            <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_summarize</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">examples</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
            <span class="n">num_beams</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">num_return_sequences</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Summarize each text in the list.</span>
<span class="sd">        Args:</span>
<span class="sd">            examples(`List[str]`): A list of texts to be summarized</span>
<span class="sd">            num_beams(`int`): Number of beams for beam search. 1 means no beam search.</span>
<span class="sd">            num_return_sequences(`int`): The number of independently computed returned sequences for each element in the batch.</span>
<span class="sd">        Returns:</span>
<span class="sd">            `List[str]`: A list of the summarization, each item corresponds to a text in the list.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Prepare the dataset</span>
        <span class="n">dict_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">examples</span><span class="p">}</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dict_data</span><span class="p">)</span>

        <span class="c1"># Tokenize for Bart, get input_ids and attention_masks</span>
        <span class="n">dataloader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_utils</span><span class="o">.</span><span class="n">get_dataloader</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_device</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

            <span class="c1"># Get token ids of summary</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">],</span> <span class="n">num_beams</span><span class="p">,</span> <span class="n">num_return_sequences</span><span class="p">)</span>
            <span class="c1"># Convert token ids to text</span>
            <span class="n">decoded_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">decoded_preds</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">_summarize_for_string</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">example</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">num_beams</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">num_return_sequences</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Summarize a text in string format.</span>

<span class="sd">        Args:</span>
<span class="sd">            example (`str`): The string to summarize.</span>
<span class="sd">            num_beams (`int`): Number of beams for beam search. 1 means no beam search.</span>
<span class="sd">            num_return_sequences(`int`): The number of independently computed returned sequences for each element in the batch.</span>
<span class="sd">        Returns:</span>
<span class="sd">           `Tuple[str, str]`:</span>
<span class="sd">                Predicted summarization and source text.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summarize</span><span class="p">([</span><span class="n">example</span><span class="p">],</span> <span class="n">num_beams</span><span class="p">,</span> <span class="n">num_return_sequences</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">,</span> <span class="s2">&quot;raw_text&quot;</span><span class="p">:</span> <span class="n">example</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_summarize_for_text</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">num_beams</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">num_return_sequences</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Summarize a document from a text file.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_beams (`int`): Number of beams for beam search. 1 means no beam search.</span>
<span class="sd">            filename (`str`): The path to the input text file.</span>
<span class="sd">            num_return_sequences(`int`): The number of independently computed returned sequences for each element in the batch.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `Tuple[str, str]`:</span>
<span class="sd">                Predicted summarization and source text.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">examples</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">examples</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">examples</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summarize</span><span class="p">(</span><span class="n">examples</span><span class="p">,</span> <span class="n">num_beams</span><span class="p">,</span> <span class="n">num_return_sequences</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">,</span> <span class="s2">&quot;raw_text&quot;</span><span class="p">:</span> <span class="n">examples</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>

    <span class="k">def</span> <span class="nf">_summarize_for_pdf</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">temp_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">BASE_TEMP_DIR</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">BASE_OUTPUT_DIR</span><span class="p">,</span>
            <span class="n">num_beams</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">num_return_sequences</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Summarize a document from a PDF file.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (`str`): The path to the pdf file to summarize.</span>
<span class="sd">            temp_dir (`Optional[str]`): The diretorcy to save intermediate file, default to `temp/`.</span>
<span class="sd">            output_dir (`Optional[str]`): The diretorcy to save text file, default to `output/`.</span>
<span class="sd">            num_return_sequences(`int`): The number of independently computed returned sequences for each element in the batch.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `Dict`:</span>
<span class="sd">                Predicted summarization and source text.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Convert PDF to JSON with doc2json.</span>
        <span class="n">json_file</span> <span class="o">=</span> <span class="n">process_pdf_file</span><span class="p">(</span><span class="n">input_file</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">temp_dir</span><span class="o">=</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">temp_dir</span><span class="p">)</span>
        <span class="c1"># Extract bodytext from pdf and save them in TEXT format.</span>
        <span class="n">text_file</span> <span class="o">=</span> <span class="n">get_bodytext</span><span class="p">(</span><span class="n">json_file</span><span class="o">=</span><span class="n">json_file</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="c1"># Do summarization</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summarize_for_text</span><span class="p">(</span><span class="n">text_file</span><span class="p">,</span> <span class="n">num_beams</span><span class="o">=</span><span class="n">num_beams</span><span class="p">,</span> <span class="n">num_return_sequences</span><span class="o">=</span><span class="n">num_return_sequences</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, WING-NUS.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>